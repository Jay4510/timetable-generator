<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Generation Metrics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-value.success {
            color: #10b981;
        }

        .metric-value.warning {
            color: #f59e0b;
        }

        .metric-value.error {
            color: #ef4444;
        }

        .metric-subtitle {
            font-size: 12px;
            color: #999;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .division-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .division-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: #f9fafb;
        }

        .division-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .division-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .division-metric {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .division-metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .division-metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .conflicts-section {
            margin-top: 20px;
        }

        .conflict-list {
            list-style: none;
            padding: 0;
        }

        .conflict-item {
            background: #fef3c7;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #f59e0b;
            font-size: 14px;
            color: #92400e;
        }

        .no-conflicts {
            background: #d1fae5;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            color: #065f46;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            background: #fef3c7;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #f59e0b;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
            margin: 20px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .timestamp {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f3f4f6;
            font-weight: bold;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Timetable Generation Metrics Dashboard</h1>
            <p>Real-time performance metrics and statistics from the genetic algorithm</p>
            <button class="refresh-btn" onclick="fetchMetrics()">Refresh Metrics</button>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <h3>Generating Timetable...</h3>
            <p>This will take 30-60 seconds. Please wait.</p>
            <div id="status-messages"></div>
        </div>

        <div id="error" style="display: none;"></div>

        <div id="metrics-container" style="display: none;">
            <!-- Overall Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-value success" id="success-rate">0%</div>
                    <div class="metric-subtitle">Overall generation success</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="success-progress" style="width: 0%">0%</div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Total Divisions</div>
                    <div class="metric-value" id="total-divisions">0</div>
                    <div class="metric-subtitle">Divisions processed</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Successful Divisions</div>
                    <div class="metric-value success" id="successful-divisions">0</div>
                    <div class="metric-subtitle">Successfully generated</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Total Conflicts</div>
                    <div class="metric-value" id="total-conflicts">0</div>
                    <div class="metric-subtitle">Scheduling conflicts detected</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Conflict Free</div>
                    <div class="metric-value" id="conflict-free">No</div>
                    <div class="metric-subtitle">Zero conflicts status</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Algorithm</div>
                    <div class="metric-value" style="font-size: 18px;" id="algorithm">N/A</div>
                    <div class="metric-subtitle">Generation method used</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Years Processed</div>
                    <div class="metric-value" id="years-processed">0</div>
                    <div class="metric-subtitle">Academic years handled</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Execution Time</div>
                    <div class="metric-value" id="execution-time">0s</div>
                    <div class="metric-subtitle">Time taken to generate</div>
                </div>
            </div>

            <!-- Division-wise Results -->
            <div class="section">
                <h2>Division-wise Performance</h2>
                <div id="divisions-container" class="division-grid">
                    <!-- Division cards will be inserted here -->
                </div>
            </div>

            <!-- Conflicts Report -->
            <div class="section">
                <h2>Conflicts Report</h2>
                <div id="conflicts-container">
                    <!-- Conflicts will be inserted here -->
                </div>
            </div>

            <!-- Database Statistics -->
            <div class="section">
                <h2>Database Statistics</h2>
                <table id="database-stats">
                    <thead>
                        <tr>
                            <th>Entity</th>
                            <th>Count</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Database stats will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Detailed Metrics Table -->
            <div class="section">
                <h2>Detailed Metrics</h2>
                <table id="detailed-metrics">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Detailed metrics will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        function addStatusMessage(message) {
            const statusDiv = document.getElementById('status-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'status-message';
            msgDiv.textContent = message;
            statusDiv.appendChild(msgDiv);
        }

        async function fetchMetrics() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('metrics-container');
            const statusMessages = document.getElementById('status-messages');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            container.style.display = 'none';
            statusMessages.innerHTML = '';

            try {
                addStatusMessage('Step 1/3: Connecting to backend...');
                
                // First, get database status
                const dbResponse = await fetch('http://localhost:8000/api/user-driven/test/');
                const dbData = await dbResponse.json();
                
                addStatusMessage('Step 2/3: Preparing template data (20 teachers, 7 subjects)...');

                // Create template data for generation
                const teachers = [];
                for (let i = 1; i <= 20; i++) {
                    teachers.push({
                        id: `T${i}`,
                        name: `Teacher ${i}`,
                        designation: 'Professor',
                        experience: 5 + (i % 10),
                        assignedYears: ['BE']
                    });
                }

                const subjects = [
                    { id: 'S1', code: 'CS401', name: 'Machine Learning', year: 'BE', sessionsPerWeek: 4 },
                    { id: 'S2', code: 'CS402', name: 'Big Data Analytics', year: 'BE', sessionsPerWeek: 4 },
                    { id: 'S3', code: 'CS403', name: 'Cloud Computing', year: 'BE', sessionsPerWeek: 3 },
                    { id: 'S4', code: 'CS404', name: 'Cyber Security', year: 'BE', sessionsPerWeek: 3 },
                    { id: 'S5', code: 'CS405', name: 'Internet of Things', year: 'BE', sessionsPerWeek: 3 },
                    { id: 'S6', code: 'CS406', name: 'Blockchain Technology', year: 'BE', sessionsPerWeek: 3 },
                    { id: 'S7', code: 'CS407', name: 'Major Project', year: 'BE', sessionsPerWeek: 4 }
                ];

                addStatusMessage('Step 3/3: Running genetic algorithm (this takes 30-60 seconds)...');

                // Then, generate timetable with actual data
                const genResponse = await fetch('http://localhost:8000/api/user-driven/generate/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_data: {
                            yearsManaged: ['BE'],
                            college_start_time: '09:00',
                            college_end_time: '17:45',
                            recess_start: '13:00',
                            recess_end: '13:45',
                            professor_year_assignments: {
                                'BE': teachers.map(t => t.id)
                            },
                            teachers: teachers,
                            subjects: subjects
                        },
                        target_years: ['BE'],
                        use_user_driven: true
                    })
                });

                const genData = await genResponse.json();

                addStatusMessage('Generation complete! Processing results...');

                if (genData.status === 'success') {
                    displayMetrics(genData, dbData);
                    loading.style.display = 'none';
                    container.style.display = 'block';
                } else {
                    throw new Error(genData.message || 'Generation failed');
                }

            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.className = 'error-message';
                error.innerHTML = `
                    <strong>Error Loading Metrics:</strong><br>
                    ${err.message}<br><br>
                    <strong>Possible Solutions:</strong><br>
                    1. Make sure backend server is running on http://localhost:8000<br>
                    2. Ensure you have generated a timetable first<br>
                    3. Check browser console for detailed errors
                `;
            }
        }

        function displayMetrics(data, dbData) {
            // Overall Metrics
            const successRate = data.success_rate || 0;
            document.getElementById('success-rate').textContent = successRate.toFixed(1) + '%';
            document.getElementById('success-progress').style.width = successRate + '%';
            document.getElementById('success-progress').textContent = successRate.toFixed(1) + '%';
            
            document.getElementById('total-divisions').textContent = data.total_divisions || 0;
            document.getElementById('successful-divisions').textContent = data.successful_divisions || 0;
            
            const totalConflicts = data.total_conflicts || 0;
            const conflictsEl = document.getElementById('total-conflicts');
            conflictsEl.textContent = totalConflicts;
            conflictsEl.className = 'metric-value ' + (totalConflicts === 0 ? 'success' : totalConflicts < 5 ? 'warning' : 'error');
            
            const conflictFree = data.conflict_free || false;
            const conflictFreeEl = document.getElementById('conflict-free');
            conflictFreeEl.textContent = conflictFree ? 'Yes' : 'No';
            conflictFreeEl.className = 'metric-value ' + (conflictFree ? 'success' : 'error');
            
            document.getElementById('algorithm').textContent = data.algorithm || 'N/A';
            document.getElementById('years-processed').textContent = data.years_processed || 0;
            document.getElementById('execution-time').textContent = (data.execution_time || 0) + 's';

            // Division-wise Results
            const divisionsContainer = document.getElementById('divisions-container');
            divisionsContainer.innerHTML = '';

            if (data.results) {
                for (const [year, yearData] of Object.entries(data.results)) {
                    for (const [division, divData] of Object.entries(yearData)) {
                        const divCard = document.createElement('div');
                        divCard.className = 'division-card';
                        
                        const isSuccess = divData.success || false;
                        const fitnessScore = divData.fitness_score || 0;
                        const sessionsCount = divData.sessions_count || 0;
                        
                        divCard.innerHTML = `
                            <div class="division-header">
                                <span>${year} Division ${division}</span>
                                <span class="status-badge ${isSuccess ? 'success' : 'failed'}">
                                    ${isSuccess ? 'Success' : 'Failed'}
                                </span>
                            </div>
                            <div class="division-metrics">
                                <div class="division-metric">
                                    <div class="division-metric-label">Fitness Score</div>
                                    <div class="division-metric-value">${fitnessScore.toFixed(2)}</div>
                                </div>
                                <div class="division-metric">
                                    <div class="division-metric-label">Sessions</div>
                                    <div class="division-metric-value">${sessionsCount}</div>
                                </div>
                                <div class="division-metric">
                                    <div class="division-metric-label">Teacher Conflicts</div>
                                    <div class="division-metric-value">${divData.violations?.teacher_conflicts || 0}</div>
                                </div>
                                <div class="division-metric">
                                    <div class="division-metric-label">Room Conflicts</div>
                                    <div class="division-metric-value">${divData.violations?.room_conflicts || 0}</div>
                                </div>
                            </div>
                            ${!isSuccess && divData.error ? `
                                <div class="error-message" style="margin-top: 15px; font-size: 12px;">
                                    ${divData.error}
                                </div>
                            ` : ''}
                        `;
                        
                        divisionsContainer.appendChild(divCard);
                    }
                }
            }

            // Conflicts Report
            const conflictsContainer = document.getElementById('conflicts-container');
            const conflictsReport = data.conflicts_report || {};
            const teacherConflicts = conflictsReport.teacher_conflicts || [];
            const roomConflicts = conflictsReport.room_conflicts || [];

            if (teacherConflicts.length === 0 && roomConflicts.length === 0) {
                conflictsContainer.innerHTML = '<div class="no-conflicts">No conflicts detected - Perfect timetable!</div>';
            } else {
                let conflictsHTML = '';
                
                if (teacherConflicts.length > 0) {
                    conflictsHTML += '<h3>Teacher Conflicts</h3><ul class="conflict-list">';
                    teacherConflicts.forEach(conflict => {
                        conflictsHTML += `<li class="conflict-item">${conflict}</li>`;
                    });
                    conflictsHTML += '</ul>';
                }
                
                if (roomConflicts.length > 0) {
                    conflictsHTML += '<h3>Room Conflicts</h3><ul class="conflict-list">';
                    roomConflicts.forEach(conflict => {
                        conflictsHTML += `<li class="conflict-item">${conflict}</li>`;
                    });
                    conflictsHTML += '</ul>';
                }
                
                conflictsContainer.innerHTML = conflictsHTML;
            }

            // Database Statistics
            if (dbData && dbData.database_status) {
                const dbStats = dbData.database_status;
                const dbTable = document.getElementById('database-stats').getElementsByTagName('tbody')[0];
                dbTable.innerHTML = '';

                const entities = [
                    { name: 'Teachers', count: dbStats.teachers },
                    { name: 'Subjects', count: dbStats.subjects },
                    { name: 'Rooms', count: dbStats.rooms },
                    { name: 'Labs', count: dbStats.labs },
                    { name: 'Years', count: dbStats.years },
                    { name: 'Divisions', count: dbStats.divisions }
                ];

                entities.forEach(entity => {
                    const row = dbTable.insertRow();
                    row.innerHTML = `
                        <td>${entity.name}</td>
                        <td><strong>${entity.count}</strong></td>
                        <td><span class="status-badge ${entity.count > 0 ? 'success' : 'failed'}">
                            ${entity.count > 0 ? 'Available' : 'Empty'}
                        </span></td>
                    `;
                });
            }

            // Detailed Metrics
            const detailedTable = document.getElementById('detailed-metrics').getElementsByTagName('tbody')[0];
            detailedTable.innerHTML = '';

            const detailedMetrics = [
                { metric: 'Status', value: data.status, description: 'Overall generation status' },
                { metric: 'Success Rate', value: successRate.toFixed(2) + '%', description: 'Percentage of successful divisions' },
                { metric: 'Total Divisions', value: data.total_divisions, description: 'Number of divisions processed' },
                { metric: 'Successful Divisions', value: data.successful_divisions, description: 'Divisions generated successfully' },
                { metric: 'Failed Divisions', value: (data.total_divisions - data.successful_divisions), description: 'Divisions that failed to generate' },
                { metric: 'Total Conflicts', value: totalConflicts, description: 'Sum of all scheduling conflicts' },
                { metric: 'Conflict Free', value: conflictFree ? 'Yes' : 'No', description: 'Whether timetable has zero conflicts' },
                { metric: 'Years Processed', value: data.years_processed, description: 'Number of academic years handled' },
                { metric: 'Algorithm Used', value: data.algorithm, description: 'Generation algorithm employed' },
                { metric: 'Execution Time', value: (data.execution_time || 0) + ' seconds', description: 'Time taken for generation' }
            ];

            detailedMetrics.forEach(item => {
                const row = detailedTable.insertRow();
                row.innerHTML = `
                    <td><strong>${item.metric}</strong></td>
                    <td>${item.value}</td>
                    <td style="color: #666;">${item.description}</td>
                `;
            });

            // Update timestamp
            document.getElementById('timestamp').textContent = 
                'Last updated: ' + new Date().toLocaleString();
        }

        // Auto-load on page load
        window.onload = fetchMetrics;

        // Auto-refresh every 30 seconds (optional)
        // setInterval(fetchMetrics, 30000);
    </script>
</body>
</html>
